{% extends "base.html" %}
{% block content %}

    <div class="flex">
        <div class="flex-none w-1/3  ">
        </div>
        <div class="grow  w-full ">
            <div class=" relative flex flex-col justify-center  overflow-hidden">
                <div class="   rounded-md lg:max-w-xl">
                    <h1 class="text-amber-50 block  text-2xl font-bold mb-2  text-center  ">Simulator</h1>
                    <h2 class="text-amber-500 block  text-sm font-bold mb-2  text-center  ">Predict category</h2>
                    <form id="frmPredict">
                        <div class="mb-4 pt-3">
                            <label class="block  text-sm font-bold mb-2" for="name">
                                Name
                            </label>
                            <input class=" appearance-none border rounded w-full py-1 px-1  leading-tight focus:outline-none focus:-outline "
                                   id="name" type="text" placeholder="">
                        </div>
                        <div class="pt-3">
                            <label class="block  text-sm font-bold mb-2" for="description">
                                Description
                            </label>
                            <textarea
                                    class=" appearance-none border rounded w-full py-1 px-1  mb-3 leading-tight focus:outline-none focus:-outline "
                                    id="description" placeholder=""></textarea>
                        </div>
                        <div class="pt-3">
                            <label class="block  text-sm font-bold mb-2" for="price">
                                Price
                            </label>
                            <input
                                    class=" appearance-none border rounded w-full py-1 px-1  leading-tight focus:outline-none focus:-outline "
                                    id="price" placeholder="0.0"></input>
                        </div>
                        <div class=" pt-3">
                            <label class="block  text-sm font-bold mb-2" for="type-input">
                                Type
                            </label>

                            <input list="type-data" id="type-input" name="q"
                                   class="appearance-none border rounded w-full py-1 px-1 leading-tight focus:outline-none focus:-outline "
                                   placeholder="Start typing..." size="50"
                                   autocomplete="off" hx-get="/api/v1/type/search/"
                                   hx-trigger="keyup changed delay:500ms"
                                   hx-target="#type-response-container"
                                   hx-include="#type-input">
                            <datalist id="type-data"> <!-- Las opciones se llenarán aquí por JavaScript -->
                            </datalist>
                            <div id="type-response-container" style="display: none;"></div>

                        </div>
                         <div class=" pt-3">
                            <label class="block  text-sm font-bold mb-2" for="manufacturer-input">
                                Manufacturer
                            </label>

                            <input list="manufacturer-data"
                                   id="manufacturer-input"
                                   name="q"
                                   class="appearance-none border rounded w-full py-1 px-1 leading-tight focus:outline-none focus:-outline "
                                   placeholder="Start typing..." size="50"
                                   autocomplete="off"
                                   hx-get="/api/v1/manufacturer/search/"
                                   hx-trigger="keyup changed delay:500ms"
                                   hx-target="#manufacturer-response-container"
                                   hx-include="#manufacturer-input">
                            <datalist id="manufacturer-data"> <!-- Las opciones se llenarán aquí por JavaScript -->
                            </datalist>
                            <div id="manufacturer-response-container" style="display: none;"></div>

                        </div>


                        <div class="flex flex-row items-center justify-end p-3">
                            <ul class="menu menu-horizontal bg-base-200 p-1">
                                <li class="btn btn-neutral "><a href="javascript:void(0);"
                                                                onclick="cleanForm()">Clean</a>
                                </li>
                                <button type="submit" class="btn btn-accent">Predict</button>
                            </ul>

                        </div>
                    </form>
                    <!-- Div donde se mostrará la respuesta -->
                    <div id="response"></div>
                    <!-- Div donde se mostrará el error-->


                    <dialog id="modal" class="modal bg-base-100 rounded-lg p-5">
                        <div class="modal-box relative">
                            <h3 class="font-bold text-lg p-3">Attention!</h3>
                            <p class="p-6">Please fill out all fields correctly or try again.</p>
                            <div class="modal-action flex justify-end p-3">
                                <button class="btn  btn-active " onclick="document.getElementById('modal').close()">
                                    Close
                                </button>
                            </div>
                        </div>
                    </dialog>
                </div>
            </div>

        </div>

        {% include "partials/_footer.html" %}

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            console.log('Start')
            const form = document.getElementById('frmPredict');
            form.addEventListener('submit', predictForm);

            document.body.addEventListener('htmx:afterSwap', function (event) {
                  console.log('Start htmxSwap')

                if (event.target.id === 'type-response-container') {
                    const datalist = document.getElementById('type-data');
                     console.log('type-data')

                    datalist.innerHTML = event.target.innerHTML;
                      console.log(event.target.innerHTML)
                    event.target.innerHTML = '';
                }

                 if (event.target.id === 'manufacturer-response-container') {
                    const datalist = document.getElementById('manufacturer-data');
                     console.log('manufacturer-data')

                    datalist.innerHTML = event.target.innerHTML;
                      console.log(event.target.innerHTML)
                    event.target.innerHTML = '';
                }
            });

        });


        var ws;
        const retryInterval = 2000; // Reconnect attempt every 2 seconds
        const timeout = 5000; // Connection timeout of 5 seconds
        let timeoutChecker;

        function connectWebSocket() {
            if (!ws || ws.readyState === WebSocket.CLOSED) {
                ws = new WebSocket("ws://127.0.0.1:9000/ws");

                ws.onopen = function () {
                    clearTimeout(timeoutChecker); // Clear the timeout checker upon successful connection
                    console.log("WebSocket connection opened");
                };

                ws.onmessage = function (event) {
                    var message = event.data;
                    alert("Predict: " + message);
                };

                ws.onerror = function (error) {
                    // Log WebSocket errors to the console
                    console.error("WebSocket connection error", error);
                };

                ws.onclose = function (event) {
                    // Attempt to reconnect after a delay when the connection closes
                    console.log("WebSocket connection closed. Attempting to reconnect...");
                    setTimeout(connectWebSocket, retryInterval);
                };

                // Set a timeout for the connection
                timeoutChecker = setTimeout(function () {
                    // If the connection is not open by the timeout, close the WebSocket
                    if (ws.readyState !== WebSocket.OPEN) {
                        console.log("WebSocket connection timed out. Closing...");
                        ws.close();
                    }
                }, timeout);
            }
        }


        function cleanForm() {
            document.getElementById('name').value = '';
            document.getElementById('description').value = '';
            document.getElementById('price').value = '0.0';
            document.getElementById('type-input').value = '';
            document.getElementById('manufacturer-input').value = '';
            // Remover mensaje de error si existe
            const errorDiv = document.getElementById('error-message');
            if (errorDiv) {
                errorDiv.remove();
            }
        }

        function predictForm(event) {

            event.preventDefault();

            connectWebSocket();

            const name = document.getElementById('name').value.trim();
            const description = document.getElementById('description').value.trim();
            const price = document.getElementById('price').value.trim();
            const type = document.getElementById('type-input').value;
            const manufacturer = document.getElementById('manufacturer-input').value;

            function sendMessage(json) {
                console.log('activo socket')
                if (ws.readyState === WebSocket.OPEN) {
                    console.log('enviando socket')
                    ws.send(json);

                } else {
                    // Alert the user if the WebSocket connection isn't open
                    alert("WebSocket connection is not open. Please try again.");
                }
            }


            if (!name || !description || !price || type === '' || manufacturer === '') {
                displayError("Please fill out all fields correctly.");
                return;
            }
            console.log("enviando info")
            const data = {name, description, price, type, manufacturer};
            const jsonData = JSON.stringify(data);
            console.log(jsonData)

            sendMessage(jsonData)
            /*
            fetch('api/v1/predict', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: jsonData
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    document.getElementById('response').innerHTML = JSON.stringify(data);
                    cleanForm(); // Opcional: limpiar formulario después del envío exitoso
                })
                .catch((error) => {
                    console.error('Error:', error);
                    displayError("Failed to predict. Please try again.");
                });

             */
        }

        function displayError(message) {

            document.getElementById('modal').showModal()
        }


    </script>

{% endblock content %}
